#
# mkresp_point_ng.txt
#

#
# for grism data (point)
#

cd /mnt/volume/akari/ana/specdcv/1600060.1.N3/target2

# PSF image
ln -s /mnt/volume/akari/data/spectrum/AKARI_IRC_1600060_001/1600060.1/irc_specred_out/1600060.1.N3_NG.refimage_bg.fits

# spec image
ln -s /mnt/volume/akari/data/spectrum/AKARI_IRC_1600060_001/1600060.1/irc_specred_out/1600060.1.N3_NG.specimage_bg.fits

--> 1600060.1.N3_NG.refimage_bg.fits
--> 1600060.1.N3_NG.specimage_bg.fits


ds9 ~/Documents/docker/volume/ubuntu/akari/data/spectrum/AKARI_IRC_1600060_001/1600060.1/irc_specred_out/1600060.1.N3_NG.specimage_bg.fits \
~/Documents/docker/volume/ubuntu/akari/data/spectrum/AKARI_IRC_1600060_001/1600060.1/irc_specred_out/1600060.1.N3_NG.refimage_bg.fits &

#### trim for the subimage

mkdir trim_ng

## trim spec image and convert cube to image
in_img=1600060.1.N3_NG.specimage_bg.fits
x_lo=55
x_up=80
y_lo=5
y_up=300
outdir=trim_ng
outfile_head=specimage

/home/morii/work/github/moriiism/specdcv/trim/trim \
$in_img \
$x_lo \
$x_up \
$y_lo \
$y_up \
$outdir \
$outfile_head

# trim refimage and convert cube to image
in_img=1600060.1.N3_NG.refimage_bg.fits
x_lo=55
x_up=80
y_lo=5
y_up=300
outdir=trim_ng
outfile_head=refimage

/home/morii/work/github/moriiism/specdcv/trim/trim \
$in_img \
$x_lo \
$x_up \
$y_lo \
$y_up \
$outdir \
$outfile_head


# source position of PSF star
x_lo=240
x_up=260
y_lo=280
y_up=300

# trim psf image and convert cube to image
in_img=1600060.1.N3_NG.refimage_bg.fits
x_lo=240
x_up=260
y_lo=280
y_up=300
outdir=trim_ng
outfile_head=refimage_psf

/home/morii/work/github/moriiism/specdcv/trim/trim \
$in_img \
$x_lo \
$x_up \
$y_lo \
$y_up \
$outdir \
$outfile_head



# spec responese file (NG):
# 1st. line is dummy.
# wavelength, sensitivity (ADU/Jy), error of sensitivity (ADU/Jy)

ln -s /mnt/volume/akari/IRC_SPEC_TOOLKIT/IRC_SPEC_TOOLKIT_P12.20181203/ASTRO-F/IRC_SPECRED/CALIBDIR/RESPONSE/response_NG_1st_P2.dat

--> response_NG_1st_P2.dat

# point source positions of trimed image
cat << EOF > point_src.txt
# x y
5 206
EOF

# mkresp
# img_ref=trim_ng/refimage_trim.fits

img_spec=trim_ng/specimage_trim.fits
img_psf=trim_ng/refimage_psf_trim.fits
spec_resp_dat=response_NG_1st_P2.dat
point_src_dat=point_src.txt
plus_minus_for_delta_pix="plus"
npix_x_jitter=6
outdir=resp_point_ng
outfile_head=point_ng

/home/morii/work/github/moriiism/specdcv/mkresp/mkresp_point_ng \
$img_spec \
$img_psf \
$spec_resp_dat \
$point_src_dat \
$plus_minus_for_delta_pix \
$npix_x_jitter \
$outdir \
$outfile_head


--> /mnt/volume/akari/ana/specdcv/resp_point_ng/point_ng_resp.fits

# deconvolve

#ndetx = 80 - 55 + 1 = 26
#ndety = 300 - 5 + 1 = 296
#nskyz=291
#nskys=1
#ndetx=26
#ndety=296


data_file=trim_ng/specimage_trim.fits
point_src_dat=point_src.txt
resp_file=resp_point_ng/point_ng_resp.fits
eff_file=resp_point_ng/point_ng_eff.fits
skyz_lambda_file=resp_point_ng/point_ng_skyz_lambda.dat
ratio_ele_to_adu=10.0
nem=1000
tol_em=1.0e-5
acc_method=none
outdir=deconv_ng
outfile_head=point_ng

/home/morii/work/github/moriiism/specdcv/deconv/deconv \
$data_file \
$point_src_dat \
$resp_file \
$eff_file \
$skyz_lambda_file \
$ratio_ele_to_adu \
$nem \
$tol_em \
$acc_method \
$outdir \
$outfile_head


# convolve for check(not yet) eff file
#
#sky_file=deconv_ng/point_ng_rec.fits
#resp_file=resp_point_ng/point_ng_resp.fits
#nskyz=291
#nskys=2
#ndetx=31
#ndety=316
#outdir=conv_ng
#outfile_head=deconv_conv
#
#/home/morii/work/github/moriiism/specdcv/conv/conv \
#$sky_file \
#$resp_file \
#$nskyz \
#$nskys \
#$ndetx \
#$ndety \
#$outdir \
#$outfile_head
#

# mkspec by usual method

img_spec=trim_ng/specimage_trim.fits
spec_resp_dat=response_NG_1st_P2.dat
point_src_dat=point_src.txt
plus_minus_for_delta_pix="plus"
outdir=mkspec
outfile_head=spec

/home/morii/work/github/moriiism/specdcv/mkspec/mkspec \
$img_spec \
$spec_resp_dat \
$point_src_dat \
$plus_minus_for_delta_pix \
$outdir \
$outfile_head


